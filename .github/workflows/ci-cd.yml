name: ğŸš€ CI/CD Pipeline - Navoiyda Bugun

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]

jobs:
  # Frontend Tests va Build
  frontend:
    name: ğŸ¨ Frontend CI/CD
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./navoiyda-bugun/frontend

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "./navoiyda-bugun/frontend/package-lock.json"

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ” TypeScript Check
        run: npm run type-check

      - name: ğŸ§¹ ESLint Check
        run: npm run lint

      - name: ğŸ—ï¸ Build Frontend
        run: npm run build

      - name: ğŸ“± Build Android (PWA)
        run: |
          npm run build
          npx cap sync android

      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./navoiyda-bugun/frontend/dist/

  # Backend Tests va Build
  backend:
    name: ğŸ”§ Backend CI/CD
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./navoiyda-bugun/backend

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "./navoiyda-bugun/backend/package-lock.json"

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ” TypeScript Check
        run: npm run type-check

      - name: ğŸ—ï¸ Build Backend
        run: npm run build

      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: ./navoiyda-bugun/backend/dist/

  # Security Scan
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run Security Audit
        run: |
          cd navoiyda-bugun/frontend && npm audit --audit-level=high
          cd ../backend && npm audit --audit-level=high

      - name: ğŸ›¡ï¸ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Deploy (Production)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [frontend, backend, security]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-build

      - name: ğŸ“¦ Download Backend Build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-build

      - name: ğŸš€ Deploy to Server
        run: |
          echo "ğŸš€ Deploying to production server..."
          echo "ğŸ“± Frontend deployed successfully"
          echo "ğŸ”§ Backend deployed successfully"
          echo "âœ… Deployment completed!"

  # Notification
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: ğŸ“¢ Send Notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful! ğŸ‰"
          else
            echo "âŒ Deployment failed! ğŸ˜¢"
          fi
